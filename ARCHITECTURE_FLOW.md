# Architecture Flow Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client                               â”‚
â”‚                    (HTTP Requests)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Express Routes                             â”‚
â”‚              (cart-routes.ts)                               â”‚
â”‚  - POST /                  Create cart                       â”‚
â”‚  - GET /:sessionId         Get cart                         â”‚
â”‚  - POST /:sessionId/items  Add item                         â”‚
â”‚  - DELETE /:sessionId/...  Remove item                      â”‚
â”‚  - PUT /:sessionId/...     Update item                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CartService                                â”‚
â”‚              (cart-service.ts)                              â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  In-Memory Store (Source of Truth)                 â”‚    â”‚
â”‚  â”‚  Map<sessionId, SessionCart>                       â”‚    â”‚
â”‚  â”‚    - sessionId                                      â”‚    â”‚
â”‚  â”‚    - sfContextId  â—„â”€â”€ Maps to SF context          â”‚    â”‚
â”‚  â”‚    - items[]      â—„â”€â”€ Authoritative cart state    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  Recovery Logic:                                            â”‚
â”‚  1. Catch ContextExpiredError                              â”‚
â”‚  2. Create new SF context                                  â”‚
â”‚  3. Migrate items from SessionCart.items                   â”‚
â”‚  4. Update mapping                                          â”‚
â”‚  5. Retry operation                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SalesforceCartClient                           â”‚
â”‚          (salesforce-cart-client.ts)                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Contexts: Map<contextId, ContextData>             â”‚    â”‚
â”‚  â”‚    - context: { id, expiresAt }                     â”‚    â”‚
â”‚  â”‚    - items: CartItem[]                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  Behavior:                                                  â”‚
â”‚  - Expires contexts after 30 minutes                       â”‚
â”‚  - Throws ContextExpiredError on expired contexts          â”‚
â”‚  - Maintains cart state per context                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Normal Operation Flow

```
Client Request: Add Item
         â”‚
         â–¼
    [Express Routes]
         â”‚
         â–¼
    [CartService.addItem(sessionId, item)]
         â”‚
         â”œâ”€â”€â”€ Look up SessionCart by sessionId
         â”‚
         â–¼
    [sfClient.addItem(sfContextId, item)]
         â”‚
         â”œâ”€â”€â”€ Context valid? âœ…
         â”‚
         â–¼
    [Returns Cart with new item]
         â”‚
         â”œâ”€â”€â”€ Update SessionCart.items
         â”‚
         â–¼
    [Return success to client]
```

## Recovery Flow (Context Expired)

```
Client Request: Add Item (Context Expired 5 min ago)
         â”‚
         â–¼
    [Express Routes]
         â”‚
         â–¼
    [CartService.addItem(sessionId, item)]
         â”‚
         â”œâ”€â”€â”€ Look up SessionCart
         â”‚    SessionCart.items = [item1, item2]  â—„â”€â”€ Source of Truth
         â”‚    SessionCart.sfContextId = "ctx_expired"
         â”‚
         â–¼
    [sfClient.addItem("ctx_expired", item3)]
         â”‚
         â”œâ”€â”€â”€ Check: Date.now() > expiresAt âŒ
         â”‚
         â–¼
    [Throws ContextExpiredError]
         â”‚
         â–¼
    [CartService catches error]
         â”‚
         â”œâ”€â”€â”€ RECOVERY STARTS
         â”‚
         â–¼
    [1. Create new context]
         â”‚
         â”œâ”€â”€â”€ sfClient.createContext()
         â”‚    Returns: { id: "ctx_new", expiresAt: now + 30min }
         â”‚
         â–¼
    [2. Migrate existing items from SessionCart.items]
         â”‚
         â”œâ”€â”€â”€ for (item of [item1, item2]):
         â”‚       sfClient.addItem("ctx_new", item)
         â”‚
         â–¼
    [3. Update session mapping]
         â”‚
         â”œâ”€â”€â”€ SessionCart.sfContextId = "ctx_new"
         â”‚
         â–¼
    [4. Retry original operation]
         â”‚
         â”œâ”€â”€â”€ sfClient.addItem("ctx_new", item3)
         â”‚    Returns: Cart with [item1, item2, item3]
         â”‚
         â–¼
    [5. Update SessionCart.items]
         â”‚
         â”œâ”€â”€â”€ SessionCart.items = [item1, item2, item3]
         â”‚
         â–¼
    [Return success to client with all items]
         â”‚
         â–¼
    Client receives: { items: [item1, item2, item3], total: 600 }

    âœ… Client never knew recovery happened
```

## Data Flow: Session vs Context

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Client-Facing Layer                      â”‚
â”‚                                                            â”‚
â”‚  Session ID: "sess_abc123"                                â”‚
â”‚  - Created once, never expires (in current scope)        â”‚
â”‚  - Client uses this for all operations                   â”‚
â”‚  - Maps to current Salesforce context                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Maps to
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SessionCart (In-Memory)                   â”‚
â”‚                                                            â”‚
â”‚  sessionId: "sess_abc123"                                 â”‚
â”‚  sfContextId: "ctx_xyz789"  â—„â”€â”€ Changes on recovery      â”‚
â”‚  items: [                                                 â”‚
â”‚    { id: "item_1", productId: "prod_001", ... },         â”‚
â”‚    { id: "item_2", productId: "prod_002", ... }          â”‚
â”‚  ]  â—„â”€â”€ SOURCE OF TRUTH (survives context changes)       â”‚
â”‚  createdAt: 2024-10-26T10:00:00Z                         â”‚
â”‚  lastAccessed: 2024-10-26T10:45:00Z                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ References
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Salesforce Context (Ephemeral)               â”‚
â”‚                                                            â”‚
â”‚  Context ID: "ctx_xyz789"                                 â”‚
â”‚  expiresAt: 2024-10-26T10:30:00Z  â—„â”€â”€ 30 min expiry      â”‚
â”‚  items: [...]  â—„â”€â”€ Rebuilt from SessionCart on recovery  â”‚
â”‚                                                            â”‚
â”‚  Status at 10:35: EXPIRED âŒ                              â”‚
â”‚  â†’ Triggers recovery                                      â”‚
â”‚  â†’ New context created: "ctx_new456"                      â”‚
â”‚  â†’ SessionCart.sfContextId updated to "ctx_new456"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timeline: Context Expiry and Recovery

```
Time  â”‚ Event                           â”‚ State
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00 â”‚ Client creates cart             â”‚ Session: sess_abc
      â”‚                                 â”‚ Context: ctx_001 (expires 10:30)
      â”‚                                 â”‚ Items: []
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:05 â”‚ Client adds item 1              â”‚ Session: sess_abc
      â”‚                                 â”‚ Context: ctx_001 âœ… (valid)
      â”‚                                 â”‚ Items: [item1]
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:15 â”‚ Client adds item 2              â”‚ Session: sess_abc
      â”‚                                 â”‚ Context: ctx_001 âœ… (valid)
      â”‚                                 â”‚ Items: [item1, item2]
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:30 â”‚ Context expires                 â”‚ Session: sess_abc âœ… (still valid)
      â”‚ (no client action)              â”‚ Context: ctx_001 âŒ (expired)
      â”‚                                 â”‚ SessionCart.items: [item1, item2] âœ…
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:35 â”‚ Client adds item 3              â”‚ 1. Try ctx_001 â†’ EXPIRED âŒ
      â”‚ â†’ Triggers recovery             â”‚ 2. Create ctx_002 (expires 11:05)
      â”‚                                 â”‚ 3. Migrate: item1, item2 â†’ ctx_002
      â”‚                                 â”‚ 4. Add: item3 â†’ ctx_002
      â”‚                                 â”‚ 5. Update: sess_abc â†’ ctx_002
      â”‚                                 â”‚
      â”‚ Client receives success         â”‚ Session: sess_abc âœ…
      â”‚                                 â”‚ Context: ctx_002 âœ… (new, valid)
      â”‚                                 â”‚ Items: [item1, item2, item3]
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:40 â”‚ Client gets cart                â”‚ Session: sess_abc
      â”‚                                 â”‚ Context: ctx_002 âœ… (valid)
      â”‚                                 â”‚ Items: [item1, item2, item3]
      â”‚                                 â”‚ â†’ No recovery needed
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Request                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ CartService  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚SessionOKâ”‚   â”‚ Context OK   â”‚   â”‚ Context      â”‚
    â”‚         â”‚   â”‚              â”‚   â”‚ Expired      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚                   â”‚
         â–¼               â–¼                   â–¼
    â•”â•â•â•â•â•â•â•â•â•—      â•”â•â•â•â•â•â•â•â•â•—         â•”â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ 200 OK â•‘      â•‘ 200 OK â•‘         â•‘ Recovery  â•‘
    â•šâ•â•â•â•â•â•â•â•â•      â•šâ•â•â•â•â•â•â•â•â•         â•‘  Process  â•‘
                                        â•šâ•â•â•â•â•â”¬â•â•â•â•â•â•
         â”‚               â”‚                   â”‚
         â”‚               â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚      â–¼                         â–¼
         â”‚               â”‚  â•”â•â•â•â•â•â•â•â•â•—             â•”â•â•â•â•â•â•â•â•â•â•â•—
         â”‚               â”‚  â•‘ 200 OK â•‘             â•‘ 409      â•‘
         â”‚               â”‚  â•‘Success â•‘             â•‘ Conflict â•‘
         â”‚               â”‚  â•šâ•â•â•â•â•â•â•â•â•             â•šâ•â•â•â•â•â•â•â•â•â•â•
         â”‚               â”‚      â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Response   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Special Cases:
- CartNotFoundError     â†’ 404 Not Found
- ItemNotFoundError     â†’ 404 Not Found
- ValidationError       â†’ 400 Bad Request
- RecoveryFailed        â†’ 409 Conflict
- Unknown Error         â†’ 500 Internal Server Error
```

## Key Insight: Why Recovery Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  The Magic: Separation of Session and Context                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Session (Client-Facing)                                     â”‚
â”‚  âœ… Long-lived                                                â”‚
â”‚  âœ… Client identifier                                         â”‚
â”‚  âœ… Source of truth for items                                â”‚
â”‚  âœ… Survives context changes                                 â”‚
â”‚                                                               â”‚
â”‚  Context (Salesforce)                                        â”‚
â”‚  â° 30-minute lifetime                                        â”‚
â”‚  ğŸ”„ Replaceable                                               â”‚
â”‚  ğŸ“¦ Ephemeral storage                                         â”‚
â”‚  â™»ï¸  Can be recreated from session                           â”‚
â”‚                                                               â”‚
â”‚  When context expires:                                       â”‚
â”‚  1. Session still exists âœ…                                   â”‚
â”‚  2. Session.items has all data âœ…                            â”‚
â”‚  3. Create new context from session.items âœ…                 â”‚
â”‚  4. Client never knows the difference âœ…                     â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing Strategy Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Test Pyramid                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚Integration  â”‚  17 tests                â”‚
â”‚                    â”‚  Tests      â”‚  - Full HTTP cycle       â”‚
â”‚                    â”‚             â”‚  - Context recovery E2E  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                   â•±               â•²                          â”‚
â”‚                  â•±                 â•²                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚          â”‚    Service Tests             â”‚  17 tests         â”‚
â”‚          â”‚  - CartService               â”‚  - Recovery logic â”‚
â”‚          â”‚  - Session management        â”‚  - Error handling â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â•±                                â•²                   â”‚
â”‚        â•±                                  â•²                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚         Client Tests                        â”‚  19 tests  â”‚
â”‚  â”‚  - SalesforceCartClient                     â”‚            â”‚
â”‚  â”‚  - Context expiry                           â”‚            â”‚
â”‚  â”‚  - CRUD operations                          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â”‚  Total: 53 tests - All passing âœ…                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
